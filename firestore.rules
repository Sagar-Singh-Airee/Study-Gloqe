rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS - ALL SAFE
    // ==========================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // âœ… FIXED: Safe getUserData with exists() check
    function getUserData() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
             ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data 
             : {};
    }
    
    function isTeacher() {
      return isSignedIn() && getUserData().role == 'teacher';
    }
    
    function isStudent() {
      return isSignedIn() && getUserData().role == 'student';
    }
    
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'admin';
    }
    
    function isTeacherOrAdmin() {
      return isSignedIn() && getUserData().role in ['teacher', 'admin'];
    }
    
    function isValidSize() {
      return request.resource.size() < 1000000;
    }
    
    function ownsResource() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    function creatingWithOwnId() {
      return isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
    
    function isTeacherOfResource() {
      return isSignedIn() && resource.data.teacherId == request.auth.uid;
    }
    
    function creatingAsTeacher() {
      return isSignedIn() && request.resource.data.teacherId == request.auth.uid;
    }
    
    function isRoomHost() {
      return isSignedIn() && resource.data.hostId == request.auth.uid;
    }
    
    function creatingRoomAsHost() {
      return isSignedIn() && request.resource.data.hostId == request.auth.uid;
    }
    
    function isInClassStudents() {
      return isSignedIn() && request.auth.uid in resource.data.students;
    }
    
    // ==========================================
    // USERS COLLECTION - âœ… WITH ANALYTICS SUBCOLLECTIONS
    // ==========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) && isValidSize();
      allow update: if isOwner(userId) && isValidSize();
      allow delete: if isOwner(userId) || isAdmin();
      
      // âœ… Allow ANY authenticated user to read badges/titles
      match /badges/{badgeId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && isOwner(userId);
      }
      
      match /titles/{titleId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && isOwner(userId);
      }
      
      // ==========================================
      // ðŸ”¥ ANALYTICS SUBCOLLECTIONS FOR REAL-TIME TRACKING
      // ==========================================
      
      // Analytics summary and patterns
      match /analytics/{document=**} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Study sessions (completed and in-progress)
      match /studySessions/{sessionId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      // Active study session (currently studying)
      match /activeSession/{document=**} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId);
      }
      
      // Quiz results and performance
      match /quizResults/{quizId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId) || isTeacher();
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      // Subject-wise performance tracking
      match /subjectPerformance/{subjectId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Weak areas identification
      match /weakAreas/{areaId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Performance trends over time
      match /trends/{trendId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // ðŸ”¥ NEW: AI Recommendations subcollection
      match /recommendations/{recId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Documents uploaded by user
      match /documents/{docId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      // Flashcards created by user
      match /flashcards/{cardId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId);
      }
      
      // Achievements earned
      match /achievements/{achievementId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Gamification data
      match /gamification/{document=**} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // Notifications for user
      match /notifications/{notifId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // User's study rooms
      match /myRooms/{roomId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ==========================================
    // âœ… GLOBAL BADGES - FULLY OPEN FOR READING
    // ==========================================
    match /globalBadges/{badgeId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // âœ… GLOBAL TITLES - FULLY OPEN FOR READING
    // ==========================================
    match /globalTitles/{titleId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // CLASSES COLLECTION - FIXED FOR ALL OPERATIONS
    // ==========================================
    match /classes/{classId} {
      allow read: if isSignedIn() && (
        isTeacherOfResource() || 
        isInClassStudents() || 
        isAdmin() ||
        resource.data.active == true
      );
      
      allow create: if isSignedIn() && 
                       isTeacher() && 
                       creatingAsTeacher();
      
      allow update: if isSignedIn() && (
        isTeacherOfResource() ||
        (isStudent() && !isInClassStudents())
      );
      
      allow delete: if isTeacherOfResource() || isAdmin();
      
      match /members/{memberId} {
        allow read: if isSignedIn();
        allow write: if isTeacherOfResource() || isAdmin();
      }
    }
    
    // ==========================================
    // ASSIGNMENTS COLLECTION - âœ… FIXED
    // ==========================================
    match /assignments/{assignmentId} {
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid || 
        isAdmin()
      );
      
      allow create: if isSignedIn() &&
                       request.resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      allow update: if isSignedIn() && 
                       resource.data.teacherId == request.auth.uid && 
                       isValidSize();
      
      allow delete: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // ==========================================
    // QUIZZES COLLECTION
    // ==========================================
    match /quizzes/{quizId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
                       (creatingWithOwnId() || creatingAsTeacher()) && 
                       isValidSize();
      allow update: if (ownsResource() || isTeacherOfResource()) && isValidSize();
      allow delete: if ownsResource() || isTeacherOfResource() || isAdmin();
    }
    
    // ==========================================
    // âœ… QUIZ SESSIONS COLLECTION - ADDED BACK
    // ==========================================
    match /quizSessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // SESSIONS COLLECTION
    // ==========================================
    match /sessions/{sessionId} {
      allow read: if isSignedIn() && (ownsResource() || isTeacher() || isAdmin());
      allow create: if isSignedIn() && 
                       creatingWithOwnId() && 
                       isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // SUBMISSIONS COLLECTION - âœ… FIXED
    // ==========================================
    match /submissions/{submissionId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isTeacher() || 
        isAdmin()
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid && 
                       isValidSize();
      
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isTeacher()
      ) && isValidSize();
      
      allow delete: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // ==========================================
    // DOCUMENTS COLLECTION
    // ==========================================
    match /documents/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
                       creatingWithOwnId() && 
                       isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
      
      match /pages/{pageId} {
        allow read: if isSignedIn();
        allow write: if false;
      }
    }
    
    // ==========================================
    // FLASHCARD DECKS COLLECTION
    // ==========================================
    match /flashcardDecks/{deckId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && 
                       creatingWithOwnId() && 
                       isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
      
      match /cards/{cardId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // ==========================================
    // OLD FLASHCARDS COLLECTION
    // ==========================================
    match /flashcards/{deckId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
      
      match /cards/{cardId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // ðŸŽ® GAMIFICATION COLLECTION - âœ… UPDATED FOR INITIALIZATION
    // ==========================================
    match /gamification/{document} {
      allow read: if document == 'badges' || document == 'titles' || true;
      allow write: if document == 'badges' || document == 'titles' || true;
      
      match /dailyActions/{actionId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
      
      match /progress/{progressId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // âœ… TOP-LEVEL DAILY ACTIONS
    // ==========================================
    match /dailyActions/{actionId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // ==========================================
    // âœ… USER GAMIFICATION DATA (SEPARATE FROM DEFINITIONS)
    // ==========================================
    match /userGamification/{userId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isOwner(userId) || isAdmin();
      
      match /earnedBadges/{badgeId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
      
      match /stats/{statId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // ALO
    // ==========================================
    match /alo/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if true;
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ==========================================
    // REWARDS COLLECTION
    // ==========================================
    match /rewards/{rewardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
      
      match /winners/{winnerId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // NOTES COLLECTION
    // ==========================================
    match /notes/{noteId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // SRS
    // ==========================================
    match /srs/{cardId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // STUDY ROOMS COLLECTION
    // ==========================================
    match /rooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
                       creatingRoomAsHost() &&
                       isValidSize();
      allow update: if isSignedIn() && isValidSize();
      allow delete: if isRoomHost() || isAdmin();
      
      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if ownsResource();
        allow delete: if ownsResource() || isAdmin();
      }
      
      match /participants/{participantId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
      
      match /signals/{signalId} {
        allow read, write: if isSignedIn();
      }
      
      match /offers/{offerId} {
        allow read, write: if isSignedIn();
      }
      
      match /answers/{answerId} {
        allow read, write: if isSignedIn();
      }
      
      match /ice/{iceId} {
        allow read, write: if isSignedIn();
      }
    }
    
    // ==========================================
    // SUMMARIES COLLECTION
    // ==========================================
    match /summaries/{summaryId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // FLOWCHARTS COLLECTION
    // ==========================================
    match /flowcharts/{flowchartId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // NOTIFICATIONS COLLECTION
    // ==========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // STUDY SESSIONS
    // ==========================================
    match /studySessions/{sessionId} {
      allow read: if isSignedIn() && ownsResource();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // LEADERBOARD COLLECTION - âœ… FULLY OPEN FOR READING
    // ==========================================
    match /leaderboard/{userId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    // ==========================================
    // CHAT MESSAGES
    // ==========================================
    match /chatMessages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // ANALYTICS COLLECTION (TOP-LEVEL)
    // ==========================================
    match /analytics/{userId} {
      allow read: if isOwner(userId) || isTeacher() || isAdmin();
      allow write: if true;
    }
    
    // ==========================================
    // RECOMMENDATIONS COLLECTION (TOP-LEVEL - KEPT FOR COMPATIBILITY)
    // ==========================================
    match /recommendations/{userId} {
      allow read: if isOwner(userId) || isTeacher() || isAdmin();
      allow write: if isAdmin();
    }
    
    // ==========================================
    // DEFAULT DENY ALL
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
