rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS - OPTIMIZED & SAFE
    // ==========================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
             ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data 
             : {};
    }
    
    function isTeacher() {
      return isSignedIn() && getUserData().role == 'teacher';
    }
    
    function isStudent() {
      return isSignedIn() && getUserData().role == 'student';
    }
    
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'admin';
    }
    
    function isTeacherOrAdmin() {
      return isSignedIn() && getUserData().role in ['teacher', 'admin'];
    }
    
    function isValidSize() {
      return request.resource.size() < 10000000; // 10MB limit
    }
    
    function ownsResource() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    function creatingWithOwnId() {
      return isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
    
    function isTeacherOfResource() {
      return isSignedIn() && resource.data.teacherId == request.auth.uid;
    }
    
    function creatingAsTeacher() {
      return isSignedIn() && request.resource.data.teacherId == request.auth.uid;
    }
    
    function isRoomHost() {
      return isSignedIn() && resource.data.hostId == request.auth.uid;
    }
    
    function creatingRoomAsHost() {
      return isSignedIn() && request.resource.data.hostId == request.auth.uid;
    }
    
    function isInClassStudents() {
      return isSignedIn() && request.auth.uid in resource.data.students;
    }
    
    function canAccessClass(classId) {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/classes/$(classId)) &&
        (get(/databases/$(database)/documents/classes/$(classId)).data.teacherId == request.auth.uid ||
         request.auth.uid in get(/databases/$(database)/documents/classes/$(classId)).data.students)
      );
    }
    
    // ==========================================
    // ðŸ”¥ USER EVENTS - CRITICAL FOR ANALYTICS
    // ==========================================
    match /userEvents/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidSize();
      allow update: if isSignedIn() && ownsResource();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // ðŸ”¥ SESSION SUMMARIES - ANALYTICS
    // ==========================================
    match /sessionSummaries/{summaryId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidSize();
      allow update: if isSignedIn() && ownsResource();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // USERS COLLECTION - WITH ANALYTICS SUBCOLLECTIONS
    // ==========================================
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) && isValidSize();
      allow update: if isOwner(userId) && isValidSize();
      allow delete: if isOwner(userId) || isAdmin();
      
      // Badges and titles
      match /badges/{badgeId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
      
      match /titles/{titleId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId);
      }
      
      // Analytics subcollections
      match /analytics/{document=**} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /studySessions/{sessionId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      match /activeSession/{document=**} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId);
      }
      
      match /quizResults/{quizId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId) || isTeacher();
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      match /subjectPerformance/{subjectId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /weakAreas/{areaId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /trends/{trendId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /recommendations/{recId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      // ðŸ¤– AI Analytics Reports
      match /aiReports/{reportId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId);
      }
      
      match /documents/{docId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId) || isAdmin();
      }
      
      match /flashcards/{cardId} {
        allow read: if isOwner(userId) || isTeacher() || isAdmin();
        allow write: if isOwner(userId);
      }
      
      match /achievements/{achievementId} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /gamification/{document=**} {
        allow read: if isOwner(userId) || isAdmin();
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /notifications/{notifId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId) || isAdmin();
      }
      
      match /myRooms/{roomId} {
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
      }
    }
    
    // ==========================================
    // FOLDERS COLLECTION - Smart Organization
    // ==========================================
    match /folders/{folderId} {
      allow read: if isSignedIn() && (ownsResource() || isTeacher() || isAdmin());
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // DOCUMENTS COLLECTION
    // ==========================================
    match /documents/{docId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
      
      match /pages/{pageId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && 
                        get(/databases/$(database)/documents/documents/$(docId)).data.userId == request.auth.uid;
      }
      
      // ðŸ”¥ NEW: Visual Pages Subcollection for Real-time Streaming
      match /visualPages/{pageId} {
        allow read: if isSignedIn();
        allow create, update: if isSignedIn() && 
                               (get(/databases/$(database)/documents/documents/$(docId)).data.userId == request.auth.uid ||
                                get(/databases/$(database)/documents/documents/$(docId)).data.uploaderId == request.auth.uid);
        allow delete: if isSignedIn() && 
                         get(/databases/$(database)/documents/documents/$(docId)).data.userId == request.auth.uid;
      }
    }
    
    // ==========================================
    // GAMIFICATION COLLECTION (User-Specific)
    // ==========================================
    match /gamification/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) && isValidSize();
      allow update: if isSignedIn(); // Allow system updates
      allow delete: if isOwner(userId) || isAdmin();

      match /dailyChallenges/{document=**} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      match /dailyActions/{document=**} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }
    
    // ==========================================
    // ðŸ†• ACHIEVEMENTS COLLECTION (TOP-LEVEL) - LEGACY SUPPORT
    // ==========================================
    match /achievements/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId) && isValidSize();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ==========================================
    // GLOBAL BADGES - Public Read, Admin Write
    // ==========================================
    match /globalBadges/{badgeId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // GLOBAL TITLES - Public Read, Admin Write
    // ==========================================
    match /globalTitles/{titleId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // ðŸŽ“ CLASSES COLLECTION - âœ… FIXED FOR STUDENT JOIN
    // ==========================================
    match /classes/{classId} {
      // âœ… READ: Allow students to read ALL classes (needed to search by classCode)
      allow read: if isSignedIn();
      
      // CREATE: Only teachers can create classes
      allow create: if isSignedIn() && 
                       isTeacher() && 
                       creatingAsTeacher() &&
                       isValidSize();
      
      // âœ… UPDATE: Fixed to allow students to join by updating students array + count + timestamp
      allow update: if isSignedIn() && (
        // Teachers can update everything
        isTeacherOfResource() ||
        isAdmin() ||
        // âœ… Students can join: modify 'students', 'studentCount', 'updatedAt' fields only
        (isStudent() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['students', 'studentCount', 'updatedAt']) &&
         request.resource.data.students.hasAll(resource.data.get('students', [])) &&
         request.auth.uid in request.resource.data.students &&
         !(request.auth.uid in resource.data.get('students', [])))
      ) && isValidSize();
      
      // DELETE: Only class owner or admin
      allow delete: if isTeacherOfResource() || isAdmin();
      
      match /members/{memberId} {
        allow read: if isSignedIn();
        allow write: if isTeacherOfResource() || isAdmin();
      }
      
      match /announcements/{announcementId} {
        allow read: if isSignedIn();
        allow create: if isTeacherOfResource();
        allow update: if isTeacherOfResource();
        allow delete: if isTeacherOfResource() || isAdmin();
      }
      
      match /materials/{materialId} {
        allow read: if isSignedIn();
        allow create: if isTeacherOfResource();
        allow update: if isTeacherOfResource();
        allow delete: if isTeacherOfResource() || isAdmin();
      }
    }
    
    // ==========================================
    // ðŸ“¹ LIVE SESSIONS COLLECTION (liveSessions) - TEACHER DASHBOARD
    // ==========================================
    match /liveSessions/{sessionId} {
      // Read: Teacher, enrolled students, or admin
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin() ||
        (exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
         request.auth.uid in get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.students)
      );
      
      // Create: Only teachers
      allow create: if isSignedIn() && 
                       isTeacher() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      // Update: Session teacher only
      allow update: if isSignedIn() && 
                       resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      // Delete: Session teacher or admin
      allow delete: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin()
      );
      
      match /participants/{participantId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && (
          get(/databases/$(database)/documents/liveSessions/$(sessionId)).data.teacherId == request.auth.uid ||
          participantId == request.auth.uid
        );
      }
      
      match /recordings/{recordingId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && 
                        get(/databases/$(database)/documents/liveSessions/$(sessionId)).data.teacherId == request.auth.uid;
      }
    }
    
    // ==========================================
    // ðŸ“ ASSIGNMENTS COLLECTION - ENHANCED
    // ==========================================
    match /assignments/{assignmentId} {
      // Read: Teacher, students in assigned classes, admin
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid || 
        isAdmin() ||
        (exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
         request.auth.uid in get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.students)
      );
      
      // Create: Teachers only
      allow create: if isSignedIn() &&
                       isTeacher() &&
                       request.resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      // Update: Teacher (grades), students (submissions)
      allow update: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        (isStudent() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['submissions']))
      ) && isValidSize();
      
      // Delete: Teacher or admin
      allow delete: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid || 
        isAdmin()
      );
      
      match /submissions/{submissionId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn() && isStudent();
        allow update: if isSignedIn() && (
          isTeacher() || 
          get(/databases/$(database)/documents/assignments/$(assignmentId)/submissions/$(submissionId)).data.studentId == request.auth.uid
        );
        allow delete: if isTeacher() || isAdmin();
      }
    }
    
    // ==========================================
    // ðŸ“š MATERIALS COLLECTION - TEACHER DASHBOARD
    // ==========================================
    match /materials/{materialId} {
      // Read: Teacher, students in target classes
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin() ||
        (exists(/databases/$(database)/documents/classes/$(resource.data.classId)) &&
         request.auth.uid in get(/databases/$(database)/documents/classes/$(resource.data.classId)).data.students)
      );
      
      // Create: Teachers only
      allow create: if isSignedIn() && 
                       isTeacher() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      // Update: Material owner (increment downloads allowed)
      allow update: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        (isStudent() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['downloadCount', 'views']))
      ) && isValidSize();
      
      // Delete: Material owner or admin
      allow delete: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // ==========================================
    // ðŸ“¢ ANNOUNCEMENTS COLLECTION - TEACHER DASHBOARD
    // ==========================================
    match /announcements/{announcementId} {
      // Read: Teacher, students in target classes
      allow read: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin() ||
        exists(/databases/$(database)/documents/classes/$(resource.data.classIds[0])) // Check at least one class
      );
      
      // Create: Teachers only
      allow create: if isSignedIn() && 
                       isTeacher() && 
                       request.resource.data.teacherId == request.auth.uid &&
                       isValidSize();
      
      // Update: Announcement owner (allow view increments)
      allow update: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        (isStudent() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views']))
      ) && isValidSize();
      
      // Delete: Announcement owner or admin
      allow delete: if isSignedIn() && (
        resource.data.teacherId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // ==========================================
    // ðŸ§  QUIZZES COLLECTION - ENHANCED
    // ==========================================
    match /quizzes/{quizId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && 
                       (creatingWithOwnId() || (isTeacher() && creatingAsTeacher())) && 
                       isValidSize();
      allow update: if (ownsResource() || isTeacherOfResource()) && isValidSize();
      allow delete: if ownsResource() || isTeacherOfResource() || isAdmin();
    }
    
    // ==========================================
    // QUIZ SESSIONS
    // ==========================================
    match /quizSessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if isSignedIn() && ownsResource();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // SESSIONS COLLECTION
    // ==========================================
    match /sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // SUBMISSIONS COLLECTION - LEGACY
    // ==========================================
    match /submissions/{submissionId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isTeacher() || 
        isAdmin()
      );
      
      allow create: if isSignedIn() && 
                       request.resource.data.userId == request.auth.uid && 
                       isValidSize();
      
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isTeacher()
      ) && isValidSize();
      
      allow delete: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isAdmin()
      );
    }
    
    // ==========================================
    // FLASHCARD DECKS COLLECTION
    // ==========================================
    match /flashcardDecks/{deckId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
      
      match /cards/{cardId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // ==========================================
    // FLASHCARDS COLLECTION
    // ==========================================
    match /flashcards/{cardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
      
      match /cards/{subcardId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // DAILY ACTIONS
    // ==========================================
    match /dailyActions/{actionId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // ==========================================
    // USER GAMIFICATION DATA (Legacy)
    // ==========================================
    match /userGamification/{userId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isOwner(userId) || isAdmin();
      
      match /earnedBadges/{badgeId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
      
      match /stats/{statId} {
        allow read: if true;
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // ALO (AI Learning Orchestrator)
    // ==========================================
    match /alo/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if true; // Allow system updates
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ==========================================
    // REWARDS COLLECTION
    // ==========================================
    match /rewards/{rewardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource() || isAdmin();
      
      match /winners/{winnerId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
    }
    
    // ==========================================
    // NOTES COLLECTION
    // ==========================================
    match /notes/{noteId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // SRS (Spaced Repetition System)
    // ==========================================
    match /srs/{cardId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // STUDY ROOMS COLLECTION
    // ==========================================
    match /rooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingRoomAsHost() && isValidSize();
      allow update: if isSignedIn() && isValidSize();
      allow delete: if isRoomHost() || isAdmin();
      
      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if ownsResource();
        allow delete: if ownsResource() || isAdmin();
      }
      
      match /participants/{participantId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn();
      }
      
      match /signals/{signalId} {
        allow read, write: if isSignedIn();
      }
      
      match /offers/{offerId} {
        allow read, write: if isSignedIn();
      }
      
      match /answers/{answerId} {
        allow read, write: if isSignedIn();
      }
      
      match /ice/{iceId} {
        allow read, write: if isSignedIn();
      }
    }
    
    // ==========================================
    // SUMMARIES COLLECTION
    // ==========================================
    match /summaries/{summaryId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // FLOWCHARTS COLLECTION
    // ==========================================
    match /flowcharts/{flowchartId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if ownsResource() && isValidSize();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // NOTIFICATIONS COLLECTION
    // ==========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource();
    }
    
    // ==========================================
    // STUDY SESSIONS
    // ==========================================
    match /studySessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId() && isValidSize();
      allow update: if isSignedIn(); // Allow system updates
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // LEADERBOARD COLLECTION - FULLY OPEN
    // ==========================================
    match /leaderboard/{userId} {
      allow read: if true;
      allow write: if isSignedIn();
    }
    
    // ==========================================
    // CHAT MESSAGES
    // ==========================================
    match /chatMessages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if ownsResource();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // ANALYTICS COLLECTION (TOP-LEVEL)
    // ==========================================
    match /analytics/{userId} {
      allow read: if isOwner(userId) || isTeacher() || isAdmin();
      allow write: if true; // Allow system writes
    }
    
    // ==========================================
    // RECOMMENDATIONS COLLECTION (TOP-LEVEL)
    // ==========================================
    match /recommendations/{userId} {
      allow read: if isOwner(userId) || isTeacher() || isAdmin();
      allow write: if isAdmin();
    }
    
    // ==========================================
    // CHALLENGES COLLECTION
    // ==========================================
    match /challenges/{challengeId} {
      allow read: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // USER CHALLENGES (Progress Tracking)
    // ==========================================
    match /userChallenges/{userChallengeId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && creatingWithOwnId();
      allow update: if isSignedIn() && ownsResource();
      allow delete: if ownsResource() || isAdmin();
    }
    
    // ==========================================
    // STREAKS COLLECTION
    // ==========================================
    match /streaks/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isSignedIn(); // Allow system updates
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ==========================================
    // DEFAULT DENY ALL - SECURITY LAST LINE
    // ==========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
